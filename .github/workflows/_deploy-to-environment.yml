# Soliguide: Useful information for those who need it
#
# SPDX-FileCopyrightText: Â© 2024 Solinum
#
# SPDX-License-Identifier: AGPL-3.0-only
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
name: _Deploy to environment

on:
  workflow_call:
    inputs:
      environment:
        type: string
        required: true
      tag:
        type: string
      registry:
        type: string
        default: ghcr.io
      deploy_api:
        type: boolean
        default: true
      deploy_frontend:
        type: boolean
        default: true
      deploy_location-api:
        type: boolean
        default: true
      deploy_soligare:
        type: boolean
        default: true
      deploy_web-app:
        type: boolean
        default: true
      deploy_widget:
        type: boolean
        default: true

jobs:
  docker_meta:
    uses: ./.github/workflows/_docker-meta.yml

  compute_tag:
    name: Compute tag for the source containers
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.compute_tag.outputs.tag }}
    needs:
      - docker_meta
    permissions: {}
    steps:
      # If we're deploying a tag we use it, otherwise we compute the tag with _docker-meta.yml
      - id: compute_tag
        run: |
          [ -n "${{ inputs.tag }}" ] && echo 'tag=${{ inputs.tag }}' >> "$GITHUB_OUTPUT" || echo 'tag=${{ fromJSON(needs.docker_meta.outputs.json).tags[0] }}' >> "$GITHUB_OUTPUT"

  tag-container-images:
    name: Tag container images for ${{ inputs.environment }}
    uses: ./.github/workflows/_tag-container-images-for-environment.yml
    needs:
      - compute_tag
    with:
      environment: ${{ inputs.environment }}
      tag: ${{ needs.compute_tag.outputs.tag }}
      registry: ${{ inputs.registry }}
      deploy_api: ${{ inputs.deploy_api }}
      deploy_frontend: ${{ inputs.deploy_frontend }}
      deploy_location-api: ${{ inputs.deploy_location-api }}
      deploy_soligare: ${{ inputs.deploy_soligare }}
      deploy_web-app: ${{ inputs.deploy_web-app }}
      deploy_widget: ${{ inputs.deploy_widget }}

  deploy-to-clever-cloud:
    name: Deploy all apps to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    if: ${{ always() }}
    environment:
      name: ${{ inputs.environment }}
    env:
      CC_PUSH_HOST: push-n3-par-clevercloud-customers.services.clever-cloud.com
    permissions:
      contents: read
    needs:
      - tag-container-images
    steps:
      - name: Checkout repository (branch)
        if: ${{ !inputs.tag }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Checkout repository (tag)
        if: ${{ inputs.tag }}
        uses: actions/checkout@v4
        with:
          ref: refs/tags/${{ inputs.tag }}
          fetch-depth: 0
          persist-credentials: true

      - name: Install parallel utils
        run: |
          sudo apt-get update
          sudo apt-get -y install parallel

      - name: Configure git for Clever Cloud deployment
        run: |
          git config --global user.email tech@solinum.org
          git config --global user.name ${{ github.actor }}

      - name: Install SSH key
        run: |
          install -m 600 -D /dev/null ~/.ssh/id_rsa
          echo "${{ secrets.CLEVER_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.CC_PUSH_HOST }} > ~/.ssh/known_hosts

      - name: Configure git remotes for deployment
        run: |
          REMOTES=()

          ${{ inputs.deploy_api }} && {
            git remote add clever-api git+ssh://git@${{ env.CC_PUSH_HOST }}/${{ secrets.API_APP_ID }}.git
            git remote add clever-api-cron git+ssh://git@${{ env.CC_PUSH_HOST }}/${{ secrets.CRON_APP_ID }}.git
            git remote add clever-api-migrations git+ssh://git@${{ env.CC_PUSH_HOST }}/${{ secrets.API_MIGRATIONS_APP_ID }}.git
            REMOTES+=(clever-api clever-api-cron clever-api-migrations)
          }

          ${{ inputs.deploy_frontend }} && {
            git remote add clever-frontend git+ssh://git@${{ env.CC_PUSH_HOST }}/${{ secrets.FRONTEND_APP_ID }}.git
            git remote add clever-maintenance-frontend git+ssh://git@${{ env.CC_PUSH_HOST }}/${{ secrets.MAINTENANCE_FRONTEND_APP_ID }}.git
            REMOTES+=(clever-frontend clever-maintenance-frontend)
          }

          ${{ inputs.deploy_location-api }} && {
            git remote add clever-location-api git+ssh://git@${{ env.CC_PUSH_HOST }}/${{ secrets.API_LOCATION_APP_ID }}.git
            REMOTES+=(clever-location-api)
          }

          ${{ inputs.deploy_widget }} && {
            git remote add clever-widget git+ssh://git@${{ env.CC_PUSH_HOST }}/${{ secrets.WIDGET_APP_ID }}.git
            git remote add clever-maintenance-widget git+ssh://git@${{ env.CC_PUSH_HOST }}/${{ secrets.MAINTENANCE_WIDGET_APP_ID }}.git
            REMOTES+=(clever-widget clever-maintenance-widget)
          }

          ${{ inputs.deploy_soligare }} && {
            git remote add clever-soligare git+ssh://git@${{ env.CC_PUSH_HOST }}/${{ secrets.SOLIGARE_APP_ID }}.git
            REMOTES+=(clever-soligare)
          }

          ${{ inputs.deploy_web-app }} && {
            git remote add clever-web-app git+ssh://git@${{ env.CC_PUSH_HOST }}/${{ secrets.WEB_APP_APP_ID }}.git
            REMOTES+=(clever-web-app)
          }

          # Export for next step
          echo "DEPLOY_REMOTES=${REMOTES[*]}" >> $GITHUB_ENV

      - name: Verify branch and remotes before deployment
        run: |
          echo "Current branch:"
          git branch
          echo -e "\nCommit info:"
          git log -1 --oneline
          echo -e "\nRemotes to deploy:"
          cat ./remotes-to-deploy-to.txt
          echo -e "\nGit remotes:"
          git remote -v | grep clever

      - name: Deploy all apps to Clever Cloud
        # Run in parallel 4 git push and retries twice if it fails
        run: |
          cat ./remotes-to-deploy-to.txt | parallel --no-notice --line-buffer --tagstring '{= s/^clever-//; =}' -j 4 --retries 2 git push -f {} HEAD:master

      - name: Create GitHub Deployment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const env = '${{ inputs.environment }}';
            const deployApi = '${{ inputs.deploy_api }}' === 'true';
            const deployFrontend = '${{ inputs.deploy_frontend }}' === 'true';
            const deployWebApp = '${{ inputs.deploy_web-app }}' === 'true';
            const deployWidget = '${{ inputs.deploy_widget }}' === 'true';
            const deployLocationApi = '${{ inputs.deploy_location-api }}' === 'true';
            const deploySoligare = '${{ inputs.deploy_soligare }}' === 'true';

            // DÃ©terminer le domaine selon l'environnement
            const baseDomain = env === 'staging' ? 'staging.soliguide.dev' :
                               env === 'production' ? 'soliguide.fr' :
                               'unknown';

            // Construire la liste des URLs
            let urls = [];
            if (deployFrontend) {
              if (env === 'production') {
                urls.push(`ğŸ‡«ğŸ‡· Frontend FR: https://soliguide.fr`);
                urls.push(`ğŸ‡ªğŸ‡¸ Frontend ES: https://soliguia.es`);
                urls.push(`ğŸ´ Frontend CAT: https://soliguia.cat`);
                urls.push(`ğŸ‡¦ğŸ‡© Frontend AD: https://soliguia.ad`);
              } else {
                urls.push(`ğŸ‡«ğŸ‡· Frontend FR: https://fr.${baseDomain}`);
                urls.push(`ğŸ‡ªğŸ‡¸ Frontend ES: https://es.${baseDomain}`);
                urls.push(`ğŸ‡¦ğŸ‡© Frontend AD: https://ad.${baseDomain}`);
              }
            }
            if (deployWebApp) urls.push(`ğŸŒ Web App: https://app.${baseDomain}`);
            if (deployWidget) urls.push(`ğŸ”Œ Widget: https://widget.${baseDomain}`);
            if (deployApi) urls.push(`ğŸ”§ API: https://api.${baseDomain}`);
            if (deployLocationApi) urls.push(`ğŸ“ Location API: https://location-api.${baseDomain}`);
            if (deploySoligare) urls.push(`ğŸ” Soligare: https://soligare.${baseDomain}`);

            // CrÃ©er le deployment
            const { data: deployment } = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: env,
              description: `DÃ©ploiement Clever Cloud (${env})`,
              auto_merge: false,
              required_contexts: [],
              transient_environment: false,
            });

            // CrÃ©er le deployment status
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.id,
              state: 'success',
              environment_url: deployFrontend ?
                (env === 'production' ? 'https://soliguide.fr' : `https://fr.${baseDomain}`) :
                `https://api.${baseDomain}`,
              description: urls.join('\n'),
              log_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
            });
