# Soliguide: Useful information for those who need it
#
# SPDX-FileCopyrightText: ¬© 2024 Solinum
#
# SPDX-License-Identifier: AGPL-3.0-only
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

jobs:
  claude-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    # Conditions simplifi√©es :
    # 1. PRs de maintainers (MEMBER/OWNER/COLLABORATOR)
    # 2. Exclure PRs automatiques (renovate, dependabot, weblate)
    # 3. Exclure PRs de maintenance (chore, dependencies, upgrade)
    # 4. Ou r√©pondre aux commentaires mentionnant @claude
    # Temporairement simplifi√© pour debug - √† restaurer apr√®s tests
    if: |
      github.event_name == 'pull_request' || (
        github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        contains(github.event.comment.body, '@claude')
      )

    permissions:
      contents: read
      pull-requests: write
      issues: write
      checks: read
      actions: read

    steps:
      - name: Debug event context
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Action: ${{ github.event.action }}"
          echo "Author: ${{ github.event.pull_request.user.login }}"
          echo "Author association: ${{ github.event.pull_request.author_association }}"
          echo "PR title: ${{ github.event.pull_request.title }}"
          echo "PR number: ${{ github.event.pull_request.number || github.event.issue.number }}"

      - name: Get PR number
        id: pr-number
        run: |
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'issue_comment' && format('refs/pull/{0}/head', steps.pr-number.outputs.number) || github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Get PR files changed
        id: changed-files
        run: |
          # Get list of changed files for context
          gh pr view ${{ steps.pr-number.outputs.number }} --json files --jq '.files[].path' > /tmp/changed_files.txt
          echo "Changed files:"
          cat /tmp/changed_files.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Claude Code Review
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Prompt optimis√© pour review style Sentry
          prompt: |
            Tu es un reviewer IA expert pour Soliguide. Analyse cette Pull Request.

            ## üéØ Objectif
            Fournis une review concise, actionnable et structur√©e comme Sentry le fait.

            ## üîç Focus de l'analyse (par ordre de priorit√©)

            ### 1. üîí S√©curit√© (CRITIQUE)
            - Vuln√©rabilit√©s OWASP Top 10 (injection SQL, XSS, CSRF, etc.)
            - Authentication & Authorization : v√©rifier que les routes/endpoints sont prot√©g√©s
            - Validation des entr√©es utilisateur
            - Gestion des secrets et credentials
            - Headers de s√©curit√©

            ### 2. üêõ Bugs potentiels
            - Erreurs logiques
            - Edge cases non g√©r√©s
            - Race conditions
            - Memory leaks
            - Null/undefined non g√©r√©s

            ### 3. üß† Logique m√©tier
            - Coh√©rence avec les r√®gles m√©tier Soliguide
            - Cas d'usage correctement impl√©ment√©s
            - Impact sur les fonctionnalit√©s existantes

            ### 4. üîó Coh√©rence Frontend/Backend
            - Types TypeScript synchronis√©s (@soliguide/common)
            - Contrats API respect√©s
            - Gestion d'erreurs coh√©rente

            ### 5. üìù Qualit√© du code
            - Respect des patterns du projet (voir CLAUDE.md)
            - Maintenabilit√©
            - Tests manquants pour code critique

            ## üìã Format de sortie

            Structure ta review ainsi :

            ```
            ## ü§ñ Claude Code Review

            ### ‚úÖ Points positifs
            - [Si pertinent] Lister 1-2 points positifs

            ### ‚ö†Ô∏è Probl√®mes identifi√©s

            #### üî¥ Critique (blocant)
            - **[Fichier:ligne]** Description du probl√®me
              - Impact: ...
              - Solution: ...

            #### üü† Important (recommand√©)
            - **[Fichier:ligne]** Description
              - Solution: ...

            #### üü° Am√©liorations sugg√©r√©es
            - **[Fichier:ligne]** Description

            ### üìä R√©sum√©
            - X fichiers analys√©s
            - Y probl√®mes critiques
            - Z recommandations
            ```

            ## ‚ö° Contraintes
            - Maximum 10 points au total
            - Analyse UNIQUEMENT les fichiers modifi√©s dans cette PR
            - Sois direct et actionnable
            - Cite toujours le fichier et la ligne concern√©e
            - Propose des solutions concr√®tes pour chaque probl√®me
            - Priorise par criticit√©

      - name: Process Claude output
        if: always()
        id: process
        run: |
          OUTPUT_FILE="${{ steps.claude.outputs.execution_file }}"

          if [ -f "$OUTPUT_FILE" ]; then
            echo "‚úÖ Claude output file found"

            # Read content and escape for GitHub Actions
            CONTENT=$(cat "$OUTPUT_FILE")

            # Save to output
            {
              echo "content<<CLAUDE_EOF"
              echo "$CONTENT"
              echo "CLAUDE_EOF"
            } >> $GITHUB_OUTPUT

            echo "has_content=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Claude output file not found"
            echo "has_content=false" >> $GITHUB_OUTPUT
            echo "content=‚ö†Ô∏è La review Claude n'a pas pu √™tre g√©n√©r√©e. V√©rifier les logs." >> $GITHUB_OUTPUT
          fi

      - name: Post review comment
        if: always() && steps.process.outputs.has_content == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.pr-number.outputs.number }};
            const reviewBody = `${{ steps.process.outputs.content }}`;

            // Poster en tant que commentaire de PR (comme Sentry)
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: reviewBody
            });

            console.log(`‚úÖ Review post√©e sur PR #${prNumber}`);

      - name: Handle errors
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.pr-number.outputs.number }};
            if (!prNumber) {
              console.log('‚ùå No PR number found');
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## ‚ùå Claude Code Review - Erreur

La review automatique a rencontr√© une erreur. V√©rifier les logs du workflow.

[Voir les logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            });

            console.log('‚ùå Error notification posted')
