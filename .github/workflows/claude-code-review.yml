name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  check-pr-eligibility:
    if: github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment'
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.validate.outputs.should-run }}
      file-count: ${{ steps.validate.outputs.file-count }}
      skip-reason: ${{ steps.validate.outputs.skip-reason }}
    steps:
      - name: Validate PR eligibility
        id: validate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if @claude is mentioned (required for all reviews)
          COMMENT_BODY="${{ github.event.comment.body }}"
          if [[ ! "$COMMENT_BODY" =~ "@claude" ]]; then
            echo "should-run=false" >> $GITHUB_OUTPUT
            echo "skip-reason=no-mention" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Try to get PR number from context
          PR_NUMBER=""
          if [[ "${{ github.event.issue.pull_request.url }}" != "" ]]; then
            PR_NUMBER="${{ github.event.issue.number }}"
          elif [[ "${{ github.event.pull_request.number }}" != "" ]]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi

          if [[ -z "$PR_NUMBER" ]]; then
            echo "should-run=false" >> $GITHUB_OUTPUT
            echo "skip-reason=no-pr" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Fetch PR details
          PR_DATA=$(gh pr view $PR_NUMBER --json files --json labels --json baseRefName --json title -R ${{ github.repository }} 2>/dev/null || echo "{}")

          # Get base branch (target branch)
          BASE_BRANCH=$(echo "$PR_DATA" | jq -r '.baseRefName' 2>/dev/null || echo "")

          # Exclude PRs targeting main or develop
          if [[ "$BASE_BRANCH" == "main" ]] || [[ "$BASE_BRANCH" == "develop" ]]; then
            echo "should-run=false" >> $GITHUB_OUTPUT
            echo "skip-reason=protected-branch" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get PR title
          PR_TITLE=$(echo "$PR_DATA" | jq -r '.title' 2>/dev/null || echo "")

          # Check if it's a chore PR
          if [[ "$PR_TITLE" =~ ^chore(:|/) ]] || [[ "$PR_TITLE" =~ ^chore[[:space:]] ]]; then
            echo "should-run=false" >> $GITHUB_OUTPUT
            echo "skip-reason=chore-pr" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Count files
          FILE_COUNT=$(echo "$PR_DATA" | jq '.files | length' 2>/dev/null || echo "0")
          echo "file-count=$FILE_COUNT" >> $GITHUB_OUTPUT

          # Check file limit (max 20 files)
          if [ "$FILE_COUNT" -gt 20 ]; then
            echo "should-run=false" >> $GITHUB_OUTPUT
            echo "skip-reason=too-many-files" >> $GITHUB_OUTPUT
            exit 0
          fi

          # All checks passed!
          echo "should-run=true" >> $GITHUB_OUTPUT
          echo "✅ PR is eligible for Claude review (branch: $BASE_BRANCH, files: $FILE_COUNT)"

  claude:
    needs: check-pr-eligibility
    if: |
      needs.check-pr-eligibility.outputs.should-run == 'true' &&
      ((github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
       (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
       (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
       (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude'))))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Comment rejection reason
        if: needs.check-pr-eligibility.outputs.should-run == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const reason = '${{ needs.check-pr-eligibility.outputs.skip-reason }}';
            let message = '❌ **Claude review not available**: ';

            if (reason === 'protected-branch') {
              message += 'PR targets main/develop branch (protected)';
            } else if (reason === 'chore-pr') {
              message += 'PR is a chore (mention @claude if you want review anyway)';
            } else if (reason === 'too-many-files') {
              message += `PR has ${{ needs.check-pr-eligibility.outputs.file-count }} files (>20 limit)`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # Optional: Give a custom prompt to Claude. If this is not specified, Claude will perform the instructions specified in the comment that tagged it.
          # prompt: 'Update the pull request description to include a summary of changes.'

          # Optional: Add claude_args to customize behavior and configuration
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
          # claude_args: '--allowed-tools Bash(gh pr:*)'
